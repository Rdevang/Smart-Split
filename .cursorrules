# Smart Split - Cursor Rules
# VERSION: 2.0.0 | LAST UPDATED: 2024-12-10
# 
# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  SELF-EVOLVING RULESET                                                     ║
# ║  This file MUST be updated at the end of every conversation.              ║
# ║  Read the EVOLUTION PROTOCOL section for instructions.                     ║
# ╚═══════════════════════════════════════════════════════════════════════════╝

---

## EVOLUTION PROTOCOL

### How This File Evolves:
1. **START of conversation**: Read this entire file to understand current state
2. **DURING conversation**: Note any new patterns, decisions, or learnings
3. **END of conversation**: Update relevant sections below:
   - Add to LEARNINGS LOG with date
   - Move resolved items from PENDING to LEARNINGS
   - Add new questions to PENDING DECISIONS
   - Update MISTAKES & CORRECTIONS if errors were made
   - Increment version if significant changes

### Version Format: MAJOR.MINOR.PATCH
- MAJOR: Breaking architecture changes
- MINOR: New features/patterns added
- PATCH: Small fixes, clarifications

---

## PROJECT IDENTITY
- **Name**: Smart Split
- **Type**: Expense sharing application (Splitwise clone)
- **Stack**: Next.js 16 (App Router), TypeScript, Supabase, Tailwind CSS 4
- **Started**: 2024-12-10
- **Supabase Project**: cizakzarkdgieclbwljy

---

## TECH STACK RULES

### Frontend
- **Framework**: Next.js 16 with App Router ONLY (no Pages Router)
- **Styling**: Tailwind CSS ONLY - no CSS modules, styled-components, or inline styles
- **Components**: React Server Components by default, "use client" only when necessary
- **Icons**: lucide-react ONLY
- **Fonts**: Plus Jakarta Sans (headings), Inter (body) via next/font
- **Images**: Always use `next/image` with configured domains in `next.config.ts`

### Backend
- **Database**: Supabase (PostgreSQL)
- **Auth**: Supabase Auth (email/password, Google OAuth, GitHub OAuth)
- **API**: Server Actions preferred over API routes
- **File Storage**: Supabase Storage (avatars bucket configured)

### Form Handling
- **Validation**: Zod schemas
- **Forms**: react-hook-form with @hookform/resolvers

### Testing
- **Framework**: Jest with React Testing Library
- **Config**: `jest.config.ts` with Next.js integration
- **Setup**: `jest.setup.ts` for global mocks
- **Pattern**: Mirror `src/` structure in `src/__tests__/`

### Dependencies (Current)
```json
{
  "next": "16.0.8",
  "react": "19.2.1",
  "@supabase/supabase-js": "^2.87.1",
  "@supabase/ssr": "^0.8.0",
  "tailwindcss": "^4",
  "class-variance-authority": "^0.7.1",
  "clsx": "^2.1.1",
  "tailwind-merge": "^3.4.0",
  "lucide-react": "^0.559.0",
  "react-hook-form": "^7.68.0",
  "zod": "^4.1.13",
  "jest": "^30.2.0",
  "@testing-library/react": "^16.3.0",
  "@testing-library/jest-dom": "^6.9.1"
}
```

---

## ARCHITECTURE PRINCIPLES

### SOLID
1. **Single Responsibility**: One component/function = one job
2. **Open/Closed**: Extend via props/composition, don't modify existing components
3. **Liskov Substitution**: Components should be interchangeable with their abstractions
4. **Interface Segregation**: Small, focused interfaces over large ones
5. **Dependency Inversion**: Depend on abstractions (services, hooks), not implementations

### DRY (Don't Repeat Yourself)
- Extract repeated logic into hooks (`src/hooks/`)
- Extract repeated UI into components (`src/components/`)
- Centralize API calls in services (`src/services/`)
- Use the `cn()` utility for className merging

### Separation of Concerns
```
src/
├── app/                    # Routes and page components ONLY
│   ├── (auth)/             # Auth route group (login, register)
│   ├── (dashboard)/        # Protected dashboard routes
│   └── auth/callback/      # OAuth callback handler
├── components/    
│   ├── ui/                 # Base reusable components (Button, Input, Card)
│   ├── forms/              # Form-specific components
│   ├── layout/             # Navbar, Footer, Sidebar
│   └── features/           # Feature-specific components
├── services/               # Business logic and Supabase calls
├── hooks/                  # Custom React hooks
├── lib/                    # Utilities, configs, Supabase clients
├── types/                  # TypeScript interfaces and types
└── __tests__/              # Jest test files (mirrors src/ structure)
```

---

## CODE STYLE

### TypeScript
- Strict mode enabled
- Explicit return types on exported functions
- Use `interface` for object shapes, `type` for unions/primitives
- No `any` - use `unknown` if type is truly unknown

### Components
- Functional components only
- Props interface named `{ComponentName}Props`
- Use forwardRef for components that need ref access
- Export named exports (not default) for non-page components

### Naming Conventions
- **Files**: kebab-case (`expense-card.tsx`)
- **Components**: PascalCase (`ExpenseCard`)
- **Hooks**: camelCase with `use` prefix (`useExpenses`)
- **Services**: camelCase (`profileService`)
- **Types**: PascalCase (`Expense`, `CreateExpenseInput`)
- **Tests**: `*.test.ts` or `*.test.tsx`

### Tailwind
- Use `cn()` utility for conditional classes
- Mobile-first responsive design
- Dark mode support via `dark:` prefix
- Custom colors defined in `globals.css` under `@theme`

---

## ESTABLISHED PATTERNS

### UI Components Pattern (src/components/ui/)
```tsx
import { forwardRef } from "react";
import { cn } from "@/lib/utils";
import { cva, type VariantProps } from "class-variance-authority";

const componentVariants = cva("base-classes", {
  variants: { variant: {}, size: {} },
  defaultVariants: {},
});

interface ComponentProps extends React.HTMLAttributes<HTMLElement>,
  VariantProps<typeof componentVariants> {}

const Component = forwardRef<HTMLElement, ComponentProps>(
  ({ className, variant, size, ...props }, ref) => (
    <element
      ref={ref}
      className={cn(componentVariants({ variant, size, className }))}
      {...props}
    />
  )
);
Component.displayName = "Component";

export { Component, componentVariants };
```

### Service Pattern (src/services/)
```tsx
import { createClient } from "@/lib/supabase/client";

export const myService = {
  async getData(id: string) {
    const supabase = createClient();
    const { data, error } = await supabase
      .from("table")
      .select("*")
      .eq("id", id)
      .single();
    
    if (error) return null;
    return data;
  },

  async updateData(id: string, input: UpdateInput) {
    const supabase = createClient();
    const { error } = await supabase
      .from("table")
      .update(input)
      .eq("id", id);
    
    return { success: !error, error: error?.message };
  },
};
```

### Server Action Pattern
```tsx
"use server";

import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";

export async function actionName(formData: FormData) {
  const supabase = await createClient();
  
  // 1. Extract and validate input
  const input = formData.get("field") as string;
  
  // 2. Perform operation
  const { data, error } = await supabase.from("table").insert({});
  
  // 3. Handle errors
  if (error) return { error: error.message };
  
  // 4. Revalidate and redirect on success
  revalidatePath("/path");
  redirect("/destination");
}
```

### OAuth Action Pattern
```tsx
"use server";

export async function signInWithGoogle() {
  const supabase = await createClient();
  const headersList = await headers();
  const origin = headersList.get("origin") || "http://localhost:3000";

  const { data, error } = await supabase.auth.signInWithOAuth({
    provider: "google",
    options: {
      redirectTo: `${origin}/auth/callback`,
    },
  });

  if (error) return { error: error.message };
  if (data.url) redirect(data.url);
}
```

### Protected Layout Pattern
```tsx
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";

export default async function ProtectedLayout({ children }) {
  const supabase = await createClient();
  const { data, error } = await supabase.auth.getUser();
  
  if (error || !data?.user) {
    redirect("/login");
  }

  // Fetch additional profile data
  const { data: profile } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", data.user.id)
    .single();

  return <Layout user={profile}>{children}</Layout>;
}
```

### Test File Pattern
```tsx
import { render, screen } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { Component } from "@/components/ui/component";

describe("Component", () => {
  it("renders correctly", () => {
    render(<Component>Text</Component>);
    expect(screen.getByText("Text")).toBeInTheDocument();
  });

  it("handles user interaction", async () => {
    const user = userEvent.setup();
    const handleClick = jest.fn();
    render(<Component onClick={handleClick}>Click</Component>);
    
    await user.click(screen.getByRole("button"));
    expect(handleClick).toHaveBeenCalled();
  });
});
```

---

## SUPABASE PATTERNS

### Client Usage
- Browser: `import { createClient } from "@/lib/supabase/client"`
- Server Components/Actions: `import { createClient } from "@/lib/supabase/server"`
- Middleware: `import { updateSession } from "@/lib/supabase/middleware"`

### Row Level Security
- ALWAYS enable RLS on tables
- Create policies before inserting data
- Test policies in Supabase dashboard

### Storage Buckets
- `avatars` bucket created with RLS policies
- Max file size: 2MB
- Allowed types: image/jpeg, image/png, image/gif, image/webp

### Type Safety
- Generate types: `npx supabase gen types typescript --project-id cizakzarkdgieclbwljy > src/types/database.ts`
- Use generated types in services

---

## DATABASE SCHEMA

### Tables Created
| Table | Purpose |
|-------|---------|
| `profiles` | User profiles (extends auth.users) |
| `groups` | Expense sharing groups |
| `group_members` | Group membership junction |
| `expenses` | Individual expenses |
| `expense_splits` | Who owes what per expense |
| `settlements` | Payment records |
| `friendships` | Friend connections |
| `activities` | Activity feed log |

### Custom Types
- `expense_category`: food, transport, entertainment, utilities, rent, shopping, travel, healthcare, groceries, other
- `split_type`: equal, exact, percentage
- `member_role`: admin, member
- `friendship_status`: pending, accepted, blocked

### Key Functions
- `get_group_balances(group_uuid)` - Calculate who owes whom in a group
- `handle_new_user()` - Auto-create profile on user signup (trigger)
- `update_updated_at_column()` - Auto-update timestamps (trigger)

---

## TESTING RULES

### Always Create Tests For:
- New UI components (`src/__tests__/components/`)
- New services (`src/__tests__/services/`)
- New utilities (`src/__tests__/lib/`)
- Complex business logic

### Test Commands
```bash
npm test              # Run all tests
npm run test:watch    # Watch mode
npm run test:coverage # Coverage report
```

### Coverage Thresholds
- Branches: 70%
- Functions: 70%
- Lines: 70%
- Statements: 70%

---

## SECURITY RULES

1. Never expose service role key to client
2. Always validate user input with Zod
3. Use RLS policies for data access control
4. Sanitize user-generated content before display
5. Use HTTPS in production
6. Validate file uploads (size, type) before processing

---

## PERFORMANCE RULES

1. Use React Server Components for data fetching
2. Lazy load heavy components with `dynamic()`
3. Optimize images with `next/image` (add `unoptimized` for dynamic URLs)
4. Minimize "use client" components
5. Use Suspense boundaries for loading states

---

## LEARNINGS & DECISIONS LOG

### 2024-12-10: Session 2 - Full Feature Build

#### Database & Schema:
- Created complete database schema with 8 tables
- Used `gen_random_uuid()` instead of `uuid_generate_v4()` (built-in, no extension needed)
- Added RLS policies for all tables
- Created `avatars` storage bucket with upload/delete policies

#### Authentication:
- Email/password auth working
- Google OAuth configured (requires Google Cloud Console setup)
- GitHub OAuth configured (requires GitHub Developer settings)
- OAuth callback route at `/auth/callback`
- Error handling for auth errors (otp_expired, access_denied) via URL params

#### Dashboard & Navigation:
- Created Navbar component with profile dropdown
- Mobile-responsive hamburger menu
- Navigation links: Dashboard, Groups, Expenses, Activity
- Profile dropdown with settings and logout
- Dashboard layout fetches profile from database for latest avatar

#### Profile System:
- Profile settings page with full CRUD
- Avatar upload to Supabase Storage (2MB limit, image types only)
- Avatar delete functionality
- Profile service (`src/services/profile.ts`) for all profile operations
- Form with Zod validation for name, phone, currency

#### Testing Setup:
- Jest configured with Next.js integration
- React Testing Library for component tests
- 66 tests passing across 5 test suites
- Test files mirror src/ structure

#### Image Handling:
- Configured `next.config.ts` for external images
- Allowed domains: Google (lh3.googleusercontent.com), GitHub (avatars.githubusercontent.com), Supabase storage
- Use `unoptimized` prop for dynamic Supabase URLs

### 2024-12-10: Session 1 - Project Bootstrap

#### Decisions Made:
- **Fonts**: Plus Jakarta Sans (headings) + Inter (body)
- **Primary Color**: Teal (#14b8a6)
- **Auth Layout**: Split-screen design
- **Utility Function**: `cn()` with clsx + tailwind-merge
- **Component Variants**: CVA (class-variance-authority)

#### Architecture Established:
- Supabase SSR setup with @supabase/ssr
- Middleware handles session refresh + route protection
- Protected routes pattern: `/dashboard/*` requires auth

---

## MISTAKES & CORRECTIONS

### 2024-12-10
- **Mistake**: Used `uuid_generate_v4()` which doesn't exist in Supabase
- **Correction**: Use `gen_random_uuid()` which is built-in
- **Prevention**: Always use `gen_random_uuid()` for UUID generation

- **Mistake**: Used wrong Supabase key format (`sb_publishable_...`)
- **Correction**: Must use anon key in JWT format (`eyJ...`)
- **Prevention**: Verify key format matches JWT structure

- **Mistake**: Auth errors not handled gracefully
- **Correction**: Added `useSearchParams()` + `useMemo()` to read URL error params
- **Prevention**: Always handle error query params on auth pages

- **Mistake**: External images not loading (Google avatars)
- **Correction**: Added domains to `next.config.ts` remotePatterns
- **Prevention**: Always configure image domains for external sources

- **Mistake**: Jest import error with `next/jest`
- **Correction**: Use `next/jest.js` (with .js extension)
- **Prevention**: Check Next.js docs for correct import paths

---

## PENDING DECISIONS

- [ ] State management approach (Context vs Zustand vs none)
- [ ] Push notification implementation (Web Push vs third-party)
- [ ] Offline support requirements (PWA?)
- [ ] Settlement methods (PayPal, Venmo integration?)
- [ ] Email templates for notifications
- [ ] Mobile app strategy (React Native, PWA, or web-only?)

---

## RESOLVED DECISIONS

- [x] Image upload strategy → Supabase Storage with `avatars` bucket
- [x] Currency handling → User preference stored in profile, 8 currencies supported

---

## WHAT'S WORKING WELL

- CVA for component variants - clean, type-safe, easy to extend
- Server Actions for mutations - simpler than API routes
- Split-screen auth layout - looks professional, mobile-friendly
- Tailwind + cn() utility - fast styling, no conflicts
- Service layer pattern - clean separation of concerns
- Jest + RTL for testing - good developer experience
- Supabase Storage for files - simple API, RLS support

---

## WHAT NEEDS IMPROVEMENT

- [ ] Add loading skeletons for better UX
- [ ] Implement toast notifications for feedback
- [ ] Add error boundaries for graceful failures
- [ ] Build Groups CRUD functionality
- [ ] Build Expenses CRUD functionality
- [ ] Add activity feed with real-time updates

---

## AVOID (ANTI-PATTERNS)

❌ Don't use CSS modules or styled-components
❌ Don't use Pages Router patterns
❌ Don't fetch data in client components when server components work
❌ Don't create API routes when Server Actions suffice
❌ Don't use `any` type - use `unknown` if truly unknown
❌ Don't skip form validation with Zod
❌ Don't hardcode colors - use Tailwind classes
❌ Don't create new components for one-time use
❌ Don't skip error handling in async operations
❌ Don't commit .env files
❌ Don't use generic fonts (Arial, Roboto, system-ui as primary)
❌ Don't ignore TypeScript errors - fix them properly
❌ Don't skip writing tests for new components/services
❌ Don't use `uuid_generate_v4()` - use `gen_random_uuid()`
❌ Don't forget to add external image domains to next.config.ts

---

## FILE REGISTRY

| File | Purpose | Last Modified |
|------|---------|---------------|
| `src/lib/utils.ts` | cn() utility function | 2024-12-10 |
| `src/lib/supabase/client.ts` | Browser Supabase client | 2024-12-10 |
| `src/lib/supabase/server.ts` | Server Supabase client | 2024-12-10 |
| `src/lib/supabase/middleware.ts` | Session refresh logic | 2024-12-10 |
| `src/middleware.ts` | Route protection | 2024-12-10 |
| `src/app/(auth)/actions.ts` | Auth server actions (login, register, OAuth) | 2024-12-10 |
| `src/components/ui/button.tsx` | Button component with CVA | 2024-12-10 |
| `src/components/ui/input.tsx` | Input component | 2024-12-10 |
| `src/components/ui/card.tsx` | Card component family | 2024-12-10 |
| `src/components/layout/navbar.tsx` | Dashboard navbar with profile dropdown | 2024-12-10 |
| `src/services/profile.ts` | Profile CRUD and avatar upload | 2024-12-10 |
| `src/app/(dashboard)/layout.tsx` | Protected dashboard layout | 2024-12-10 |
| `src/app/(dashboard)/settings/profile/` | Profile settings page | 2024-12-10 |
| `src/types/database.ts` | Generated Supabase types | 2024-12-10 |
| `supabase/migrations/` | Database migrations | 2024-12-10 |
| `jest.config.ts` | Jest configuration | 2024-12-10 |
| `jest.setup.ts` | Test setup and mocks | 2024-12-10 |
| `next.config.ts` | Next.js config with image domains | 2024-12-10 |

---

## DOCUMENTATION REQUIREMENTS

### Always Update These Docs:
- `docs/CHANGELOG.md` - Add entries for new features/fixes
- `docs/development/database.md` - When schema changes
- `docs/development/components.md` - When adding components
- `docs/api/services.md` - When adding services
- `.cursorrules` - Every conversation end

### Documentation Structure:
```
docs/
├── README.md              # Quick start guide
├── CHANGELOG.md           # Version history
├── development/
│   ├── architecture.md    # System architecture
│   ├── database.md        # Database schema
│   └── components.md      # Component library
├── api/
│   └── services.md        # Service layer docs
└── guides/                # User guides (future)
```

---

## NEXT SESSION PRIORITIES

1. Build Groups feature (create, list, edit, delete, invite members)
2. Build Expenses feature (add expense, split calculation)
3. Implement real-time activity feed
4. Add toast notifications for user feedback
5. Push code to GitHub (resolve auth issues)
