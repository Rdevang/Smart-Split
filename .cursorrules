# Smart Split - Cursor Rules
# VERSION: 1.0.0 | LAST UPDATED: 2024-12-10
# 
# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  SELF-EVOLVING RULESET                                                     ║
# ║  This file MUST be updated at the end of every conversation.              ║
# ║  Read the EVOLUTION PROTOCOL section for instructions.                     ║
# ╚═══════════════════════════════════════════════════════════════════════════╝

---

## EVOLUTION PROTOCOL

### How This File Evolves:
1. **START of conversation**: Read this entire file to understand current state
2. **DURING conversation**: Note any new patterns, decisions, or learnings
3. **END of conversation**: Update relevant sections below:
   - Add to LEARNINGS LOG with date
   - Move resolved items from PENDING to LEARNINGS
   - Add new questions to PENDING DECISIONS
   - Update MISTAKES & CORRECTIONS if errors were made
   - Increment version if significant changes

### Version Format: MAJOR.MINOR.PATCH
- MAJOR: Breaking architecture changes
- MINOR: New features/patterns added
- PATCH: Small fixes, clarifications

---

## PROJECT IDENTITY
- **Name**: Smart Split
- **Type**: Expense sharing application (Splitwise clone)
- **Stack**: Next.js 16 (App Router), TypeScript, Supabase, Tailwind CSS 4
- **Started**: 2024-12-10

---

## TECH STACK RULES

### Frontend
- **Framework**: Next.js 16 with App Router ONLY (no Pages Router)
- **Styling**: Tailwind CSS ONLY - no CSS modules, styled-components, or inline styles
- **Components**: React Server Components by default, "use client" only when necessary
- **Icons**: lucide-react ONLY
- **Fonts**: Plus Jakarta Sans (headings), Inter (body) via next/font

### Backend
- **Database**: Supabase (PostgreSQL)
- **Auth**: Supabase Auth (email/password, OAuth)
- **API**: Server Actions preferred over API routes
- **File Storage**: Supabase Storage (for receipts)

### Form Handling
- **Validation**: Zod schemas
- **Forms**: react-hook-form with @hookform/resolvers

### Dependencies (Current)
```json
{
  "next": "16.0.8",
  "react": "19.2.1",
  "@supabase/supabase-js": "latest",
  "@supabase/ssr": "latest",
  "tailwindcss": "4.x",
  "class-variance-authority": "latest",
  "clsx": "latest",
  "tailwind-merge": "latest",
  "lucide-react": "latest",
  "react-hook-form": "latest",
  "zod": "latest"
}
```

---

## ARCHITECTURE PRINCIPLES

### SOLID
1. **Single Responsibility**: One component/function = one job
2. **Open/Closed**: Extend via props/composition, don't modify existing components
3. **Liskov Substitution**: Components should be interchangeable with their abstractions
4. **Interface Segregation**: Small, focused interfaces over large ones
5. **Dependency Inversion**: Depend on abstractions (services, hooks), not implementations

### DRY (Don't Repeat Yourself)
- Extract repeated logic into hooks (`src/hooks/`)
- Extract repeated UI into components (`src/components/`)
- Centralize API calls in services (`src/services/`)
- Use the `cn()` utility for className merging

### Separation of Concerns
```
src/
├── app/           # Routes and page components ONLY
├── components/    
│   ├── ui/        # Base reusable components (Button, Input, Card)
│   ├── forms/     # Form-specific components
│   ├── layout/    # Header, Footer, Sidebar, etc.
│   └── features/  # Feature-specific components (ExpenseCard, GroupList)
├── services/      # Business logic and Supabase calls
├── hooks/         # Custom React hooks
├── lib/           # Utilities, configs, Supabase clients
└── types/         # TypeScript interfaces and types
```

---

## CODE STYLE

### TypeScript
- Strict mode enabled
- Explicit return types on exported functions
- Use `interface` for object shapes, `type` for unions/primitives
- No `any` - use `unknown` if type is truly unknown

### Components
- Functional components only
- Props interface named `{ComponentName}Props`
- Use forwardRef for components that need ref access
- Export named exports (not default) for non-page components

### Naming Conventions
- **Files**: kebab-case (`expense-card.tsx`)
- **Components**: PascalCase (`ExpenseCard`)
- **Hooks**: camelCase with `use` prefix (`useExpenses`)
- **Services**: camelCase (`expenseService.ts`)
- **Types**: PascalCase (`Expense`, `CreateExpenseInput`)

### Tailwind
- Use `cn()` utility for conditional classes
- Mobile-first responsive design
- Dark mode support via `dark:` prefix
- Custom colors defined in `globals.css` under `@theme`

---

## ESTABLISHED PATTERNS

### UI Components Pattern (src/components/ui/)
```tsx
import { forwardRef } from "react";
import { cn } from "@/lib/utils";
import { cva, type VariantProps } from "class-variance-authority";

const componentVariants = cva("base-classes", {
  variants: { variant: {}, size: {} },
  defaultVariants: {},
});

interface ComponentProps extends React.HTMLAttributes<HTMLElement>,
  VariantProps<typeof componentVariants> {}

const Component = forwardRef<HTMLElement, ComponentProps>(
  ({ className, variant, size, ...props }, ref) => (
    <element
      ref={ref}
      className={cn(componentVariants({ variant, size, className }))}
      {...props}
    />
  )
);
Component.displayName = "Component";

export { Component, componentVariants };
```

### Server Action Pattern
```tsx
"use server";

import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";

export async function actionName(formData: FormData) {
  const supabase = await createClient();
  
  // 1. Extract and validate input
  const input = formData.get("field") as string;
  
  // 2. Perform operation
  const { data, error } = await supabase.from("table").insert({});
  
  // 3. Handle errors
  if (error) return { error: error.message };
  
  // 4. Revalidate and redirect on success
  revalidatePath("/path");
  redirect("/destination");
}
```

### Protected Page Pattern
```tsx
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";

export default async function ProtectedPage() {
  const supabase = await createClient();
  const { data, error } = await supabase.auth.getUser();
  
  if (error || !data?.user) {
    redirect("/login");
  }
  
  // Page content...
}
```

### Form with Validation Pattern
```tsx
"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";

const schema = z.object({
  field: z.string().min(1, "Required"),
});

type FormData = z.infer<typeof schema>;

export function MyForm() {
  const { register, handleSubmit, formState: { errors } } = useForm<FormData>({
    resolver: zodResolver(schema),
  });
  
  const onSubmit = async (data: FormData) => {
    // Handle submission
  };
  
  return <form onSubmit={handleSubmit(onSubmit)}>...</form>;
}
```

---

## SUPABASE PATTERNS

### Client Usage
- Browser: `import { createClient } from "@/lib/supabase/client"`
- Server Components/Actions: `import { createClient } from "@/lib/supabase/server"`
- Middleware: `import { updateSession } from "@/lib/supabase/middleware"`

### Row Level Security
- ALWAYS enable RLS on tables
- Create policies before inserting data
- Test policies in Supabase dashboard

### Type Safety
- Generate types: `npx supabase gen types typescript --project-id <id> > src/types/database.ts`
- Use generated types in services

---

## SECURITY RULES

1. Never expose service role key to client
2. Always validate user input with Zod
3. Use RLS policies for data access control
4. Sanitize user-generated content before display
5. Use HTTPS in production

---

## PERFORMANCE RULES

1. Use React Server Components for data fetching
2. Lazy load heavy components with `dynamic()`
3. Optimize images with `next/image`
4. Minimize "use client" components
5. Use Suspense boundaries for loading states

---

## LEARNINGS & DECISIONS LOG
<!-- Append new entries at the top with date -->

### 2024-12-10: Session 1 - Project Bootstrap

#### Decisions Made:
- **Fonts**: Plus Jakarta Sans (headings) + Inter (body) - modern, distinctive, not generic
- **Primary Color**: Teal (#14b8a6) - represents trust, money, balance
- **Auth Layout**: Split-screen design (branding left, form right on desktop)
- **Utility Function**: Created `cn()` with clsx + tailwind-merge for class handling
- **Component Variants**: Using CVA (class-variance-authority) for variant management

#### Architecture Established:
- Supabase SSR setup with @supabase/ssr
- Middleware handles session refresh + route protection
- Protected routes pattern: `/dashboard/*` requires auth
- Auth callback route: `/auth/callback` for OAuth/email confirmation
- Server actions in `src/app/(auth)/actions.ts` for auth operations

#### Components Created:
- `Button` - 6 variants (primary, secondary, outline, ghost, danger, link), 4 sizes, loading state
- `Input` - With label, error message, helper text support
- `Card` - CardHeader, CardTitle, CardDescription, CardContent, CardFooter

#### Pages Created:
- `/` - Landing page (hero, features, how-it-works, CTA, footer)
- `/login` - Login form with validation, social login buttons
- `/register` - Registration with password requirements
- `/dashboard` - Protected dashboard showing user info

---

## MISTAKES & CORRECTIONS
<!-- Document errors made and how they were fixed - helps avoid repeating -->

### 2024-12-10
- **Mistake**: Initially used wrong Supabase key format (`sb_publishable_...`)
- **Correction**: Must use anon key in JWT format (`eyJ...`)
- **Prevention**: Always verify key format matches `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

- **Mistake**: Auth errors from Supabase (otp_expired, access_denied) were not handled gracefully
- **Correction**: Added `useSearchParams()` to read URL error params and display user-friendly messages
- **Prevention**: Always handle error query params on auth pages and map error codes to friendly messages

---

## PENDING DECISIONS
<!-- Open questions to resolve in future conversations -->

- [ ] State management approach (Context vs Zustand vs none)
- [ ] Image upload strategy for receipts (Supabase Storage config)
- [ ] Push notification implementation (Web Push vs third-party)
- [ ] Offline support requirements (PWA?)
- [ ] Currency handling (multi-currency support? conversion?)
- [ ] Settlement methods (PayPal, Venmo integration?)
- [ ] Email templates for notifications
- [ ] Mobile app strategy (React Native, PWA, or web-only?)

---

## WHAT'S WORKING WELL
<!-- Patterns and approaches that are proving effective -->

- CVA for component variants - clean, type-safe, easy to extend
- Server Actions for mutations - simpler than API routes
- Split-screen auth layout - looks professional, mobile-friendly
- Tailwind + cn() utility - fast styling, no conflicts

---

## WHAT NEEDS IMPROVEMENT
<!-- Areas identified for future refactoring -->

- [ ] Add loading skeletons for better UX
- [ ] Implement toast notifications for feedback
- [ ] Add error boundaries for graceful failures
- [ ] Create shared form components to reduce duplication

---

## AVOID (ANTI-PATTERNS)
<!-- Things that caused issues or should never be done -->

❌ Don't use CSS modules or styled-components
❌ Don't use Pages Router patterns
❌ Don't fetch data in client components when server components work
❌ Don't create API routes when Server Actions suffice
❌ Don't use `any` type - use `unknown` if truly unknown
❌ Don't skip form validation with Zod
❌ Don't hardcode colors - use Tailwind classes
❌ Don't create new components for one-time use
❌ Don't skip error handling in async operations
❌ Don't commit .env files
❌ Don't use generic fonts (Arial, Roboto, system-ui as primary)
❌ Don't ignore TypeScript errors - fix them properly

---

## FILE REGISTRY
<!-- Track important files and their purposes -->

| File | Purpose | Last Modified |
|------|---------|---------------|
| `src/lib/utils.ts` | cn() utility function | 2024-12-10 |
| `src/lib/supabase/client.ts` | Browser Supabase client | 2024-12-10 |
| `src/lib/supabase/server.ts` | Server Supabase client | 2024-12-10 |
| `src/lib/supabase/middleware.ts` | Session refresh logic | 2024-12-10 |
| `src/middleware.ts` | Route protection | 2024-12-10 |
| `src/app/(auth)/actions.ts` | Auth server actions | 2024-12-10 |
| `src/components/ui/button.tsx` | Button component with CVA | 2024-12-10 |
| `src/components/ui/input.tsx` | Input component | 2024-12-10 |
| `src/components/ui/card.tsx` | Card component family | 2024-12-10 |

---

## NEXT SESSION PRIORITIES
<!-- What to work on next -->

1. Test and verify auth flow end-to-end
2. Create database schema in Supabase
3. Build groups feature (CRUD)
4. Build expense creation flow
